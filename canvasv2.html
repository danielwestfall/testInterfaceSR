<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A11y Canvas Widget with Hidden Mirror & Pagination</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: Inter, Arial, sans-serif;
      }
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        margin: -1px;
        padding: 0;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        clip-path: inset(100%);
        border: 0;
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-4 text-center">
        Accessible Canvas Widget with Pagination
      </h1>

      <div id="widgetContainer" class="flex flex-col items-center">
        <div id="canvasContainer" class="relative">
          <canvas
            id="myCanvas"
            width="560"
            height="320"
            class="border border-gray-300 rounded-lg shadow-inner"
            role="img"
            aria-labelledby="mirror-heading"
          ></canvas>

          <div id="mirror" class="visually-hidden">
            <h2 id="mirror-heading" tabindex="0"></h2>
            <p id="mirror-english-text" tabindex="0"></p>
            <p id="mirror-spanish-text" tabindex="0" lang="es"></p>
            <img id="mirror-image" src="" alt="" tabindex="0" />
            <button id="mirror-button">Click Me</button>
          </div>
        </div>

        <div id="paginationControls" class="mt-4 flex justify-center space-x-4">
          <button
            id="prevButton"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-3 rounded-full shadow-lg transition-colors focus:outline-none focus:ring-4 focus:ring-blue-300"
            aria-label="Previous Page"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
          </button>
          <button
            id="nextButton"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-3 rounded-full shadow-lg transition-colors focus:outline-none focus:ring-4 focus:ring-blue-300"
            aria-label="Next Page"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <div
        class="visually-hidden"
        aria-live="polite"
        id="aria-announcement"
      ></div>
    </div>

    <script>
      (() => {
        const canvas = document.getElementById("myCanvas");
        const ctx = canvas.getContext("2d");
        const widgetContainer = document.getElementById("widgetContainer");
        const prevButton = document.getElementById("prevButton");
        const nextButton = document.getElementById("nextButton");
        const ariaAnnouncement = document.getElementById("aria-announcement");

        const mirrorHeading = document.getElementById("mirror-heading");
        const mirrorEnglishText = document.getElementById(
          "mirror-english-text"
        );
        const mirrorSpanishText = document.getElementById(
          "mirror-spanish-text"
        );
        const mirrorImage = document.getElementById("mirror-image");
        const mirrorButton = document.getElementById("mirror-button");

        const pages = [
          {
            heading: "Page One",
            english: "This is the first page.",
            spanish: "Esta es la primera página.",
            imageAlt: "Placeholder image for one.",
          },
          {
            heading: "Page Two",
            english: "Now we are on the second page.",
            spanish: "Ahora en la segunda página.",
            imageAlt: "Placeholder image for two.",
          },
          {
            heading: "Page Three",
            english: "Welcome to the final page.",
            spanish: "Bienvenidos a la página final.",
            imageAlt: "Placeholder image for three.",
          },
        ];

        let currentPageIndex = 0;
        const imageCache = {};
        const focusItems = [
          mirrorHeading,
          mirrorEnglishText,
          mirrorSpanishText,
          mirrorImage,
          mirrorButton,
        ];

        const layout = {
          heading: { x: 20, y: 50, font: "28px Arial", height: 30 },
          english: { x: 20, y: 90, font: "18px Arial", height: 25 },
          spanish: { x: 20, y: 115, font: "18px Arial", height: 25 },
          image: { x: 20, y: 140, width: 150, height: 150 },
          button: {
            x: 200,
            y: 260,
            width: 130,
            height: 50,
            font: "20px Arial",
            text: "Click Me",
            textX: 225,
            textY: 295,
          },
        };

        function drawFocusRing(x, y, width, height) {
          ctx.save();
          ctx.strokeStyle = "#005fcc";
          ctx.lineWidth = 3;
          ctx.strokeRect(x - 4, y - 4, width + 8, height + 8);
          ctx.restore();
        }

        function drawCanvas(focusIdx = -1) {
          const page = pages[currentPageIndex];
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "black";

          // Draw heading
          const headingLayout = layout.heading;
          ctx.font = headingLayout.font;
          ctx.fillText(page.heading, headingLayout.x, headingLayout.y);
          if (focusIdx === 0) {
            const textMetrics = ctx.measureText(page.heading);
            drawFocusRing(
              headingLayout.x,
              headingLayout.y - headingLayout.height,
              textMetrics.width,
              headingLayout.height + 5
            );
          }

          // Draw English text
          const englishLayout = layout.english;
          ctx.font = englishLayout.font;
          ctx.fillText(page.english, englishLayout.x, englishLayout.y);
          if (focusIdx === 1) {
            const textMetrics = ctx.measureText(page.english);
            drawFocusRing(
              englishLayout.x,
              englishLayout.y - englishLayout.height + 5,
              textMetrics.width,
              englishLayout.height
            );
          }

          // Draw Spanish text
          const spanishLayout = layout.spanish;
          ctx.font = spanishLayout.font;
          ctx.fillText(page.spanish, spanishLayout.x, spanishLayout.y);
          if (focusIdx === 2) {
            const textMetrics = ctx.measureText(page.spanish);
            drawFocusRing(
              spanishLayout.x,
              spanishLayout.y - spanishLayout.height + 5,
              textMetrics.width,
              spanishLayout.height
            );
          }

          // Draw Image
          const imageLayout = layout.image;
          const imgSrc = `https://placehold.co/${imageLayout.width}x${
            imageLayout.height
          }/f0f0f0/333333?text=${encodeURIComponent(
            page.imageAlt.split(" ").pop()
          )}`;
          if (imageCache[imgSrc]) {
            ctx.drawImage(
              imageCache[imgSrc],
              imageLayout.x,
              imageLayout.y,
              imageLayout.width,
              imageLayout.height
            );
            if (focusIdx === 3) {
              drawFocusRing(
                imageLayout.x,
                imageLayout.y,
                imageLayout.width,
                imageLayout.height
              );
            }
          } else {
            const img = new Image();
            img.onload = () => {
              imageCache[imgSrc] = img;
              drawCanvas(focusIdx);
            };
            img.src = imgSrc;
          }

          // Draw Button
          const btnLayout = layout.button;
          ctx.fillStyle = "#007BFF";
          ctx.fillRect(
            btnLayout.x,
            btnLayout.y,
            btnLayout.width,
            btnLayout.height
          );
          if (focusIdx === 4) {
            drawFocusRing(
              btnLayout.x,
              btnLayout.y,
              btnLayout.width,
              btnLayout.height
            );
          }
          ctx.fillStyle = "white";
          ctx.font = btnLayout.font;
          ctx.fillText(btnLayout.text, btnLayout.textX, btnLayout.textY);
        }

        function updateMirror() {
          const page = pages[currentPageIndex];
          mirrorHeading.textContent = page.heading;
          mirrorEnglishText.textContent = page.english;
          mirrorSpanishText.textContent = page.spanish;
          mirrorImage.alt = page.imageAlt;
        }

        function changePage(direction) {
          currentPageIndex =
            (currentPageIndex + direction + pages.length) % pages.length;
          const page = pages[currentPageIndex];

          updateMirror();
          drawCanvas();

          const fullAnnouncement = [
            `Page ${currentPageIndex + 1} of ${pages.length}.`,
            page.heading,
            page.english,
            page.spanish,
            page.imageAlt,
            "Button: Click Me",
          ].join(". ");

          ariaAnnouncement.textContent = fullAnnouncement;

          // **NEW: Move focus to the first element (the heading) of the new page**
          mirrorHeading.focus();
        }

        nextButton.addEventListener("click", () => changePage(1));
        prevButton.addEventListener("click", () => changePage(-1));

        focusItems.forEach((el, idx) => {
          el.addEventListener("focus", () => drawCanvas(idx));
        });

        nextButton.addEventListener("blur", (e) => {
          if (!widgetContainer.contains(e.relatedTarget)) {
            drawCanvas(-1);
          }
        });
        prevButton.addEventListener("blur", (e) => {
          if (!widgetContainer.contains(e.relatedTarget)) {
            drawCanvas(-1);
          }
        });

        canvas.addEventListener("click", (e) => {
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const btn = layout.button;
          if (
            x >= btn.x &&
            x <= btn.x + btn.width &&
            y >= btn.y &&
            y <= btn.y + btn.height
          ) {
            mirrorButton.click();
          }
        });

        mirrorButton.addEventListener("click", () => {
          const messageBox = document.createElement("div");
          messageBox.textContent = "You clicked the canvas button!";
          messageBox.setAttribute("role", "alert");
          messageBox.classList.add(
            "absolute",
            "top-1/2",
            "left-1/2",
            "-translate-x-1/2",
            "-translate-y-1/2",
            "bg-white",
            "p-6",
            "rounded-lg",
            "shadow-xl",
            "border",
            "border-gray-200",
            "z-50"
          );
          document.body.appendChild(messageBox);
          setTimeout(() => messageBox.remove(), 2000);
        });

        // Initial setup
        updateMirror();
        drawCanvas();
      })();
    </script>
  </body>
</html>
